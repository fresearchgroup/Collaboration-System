{% extends 'base.html' %}

{% load static %}

{% block css%}
  <link rel="stylesheet" href="{% static 'css/ol.css' %}" type="text/css">
  <link rel="stylesheet" href="{% static 'css/ol-ext.css' %}" type="text/css">
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active"><a href="{% url 'home' %}">Home</a></li>

  {% if user.is_authenticated %}
  <li class="breadcrumb-item active"><a href="{% url 'user_dashboard' %}">PoW Creation Requests</a></li>
  {% endif %}
{% endblock %}

{% block content %}
  <table class="table" id="handleCommReq" style="font-size: small;">
    <thead class="thead-inverse">
      <tr>
        <th>Faith</th>
        <th>Details</th>
        <th>Requested</th>
        <th>Assignee</th>
        <th>Status</th>
        <th>Action on</th>
        <th>Comments</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
    {{myhtml|safe}}{% autoescape off%}
      {% for req in requestcommunitycreation %}
        <tr>
          <td><a href="{% url 'community_view' req.requestcommunity.parent.pk %}">{{ req.requestcommunity.parent }}</a></td>
          <td>
            <b>Name:</b> {{ req.name }} <br />
            <b>Description:</b> {{ req.desc }} <br />
            <b>Area:</b> {{ req.area }} <br />
            <b>City:</b> {{ req.city }} <br />
            <b>District:</b> {{ req.district }} <br />
            <b>State:</b> {{ req.state }} <br />
            <b>Pincode:</b> {{ req.pincode }} <br />
            <button onclick="displayLocation({{req.latitude}}, {{req.longitude}})">View Location on Map</button>
          </td>
          <td>
            {{ req.requestcommunity.requestedby }} <br />
            {{ req.requestcommunity.email }} <br />
            {{ req.requestcommunity.requestedon }}
          </td>
          <td>
            {{ req.assignedto }} <br /> 
            {{ req.assignedon }} <br />
            {% if req.status == 'Requested' and req.assignedto != request.user %}
              <a href="#modalassigntome" data-toggle="modal">Assign to me</a> 
              <div class="modal fade" id="modalassigntome" tabindex="-1" role="dialog" aria-labelledby="acceptcomm" aria-hidden="true">
                <div class="modal-dialog text-left" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h3 class="modal-title" id="exampleModalLabel">Assign this activity to yourself?</h3>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <form method = "post" action ="{% url 'handle_community_creation_requests' %}">
                        {% csrf_token %}
                        <input type='hidden' name = 'status' value='changeassignee'/>
                        <input type='hidden' name = 'pk' value ={{req.requestcommunity.pk}} />
                        <input type='hidden' name = 'community_parent' value ={{req.requestcommunity.parent.pk}} />            
                        Are you sure you want to assign this to yourself? 
                      </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                      <button id="commaccept" type="submit" class="btn btn-primary">Yes</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

            {% endif %}
          </td>
          <td>{{ req.status }}</td>
          <td>{{ req.actionon }}</td>
          <td>{{ req.reason }}</td>
          <td>
              <div class="btn-group" role="group" aria-label="Basic example">

                {% if req.status == 'Requested' or req.status == 'modify' %}
                  {% if req.assignedto == request.user %}
                  <a href="#modalaccept{{req.id}}" data-toggle="modal"><i class="fa fa-check fa-border" aria-hidden="true" title="Accept" style='font-size:14px;color:green; border-color:green; margin-right: 5px;'></i></a> 
                  <div class="modal fade" id="modalaccept{{req.id}}" tabindex="-1" role="dialog" aria-labelledby="acceptcomm" aria-hidden="true">
                    <div class="modal-dialog text-left" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h3 class="modal-title" id="exampleModalLabel">Verify details and Accept</h3>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">
                          <form method = "post" action ="{% url 'handle_community_creation_requests' %}">
                            {% csrf_token %}
                            <input type='hidden' name = 'status' value='accept'/>
                            <input type='hidden' name = 'pk' value ={{req.requestcommunity.pk}} />
                            <input type='hidden' name = 'community_parent' value ={{req.requestcommunity.parent.pk}} />            

                            <div class="form-group">
                              <label for="name">Name</label>
                              <input class="form-control form-control-sm" id="name" name = 'name' type="text" value="{{ req.name }}" required>
                            </div>
                            <div class="form-group">
                              <label for="desc">Description</label>
                              <textarea class="form-control is-invalid" id="description" name = 'description' required>{{ req.desc }}</textarea>
                            </div>
                            <div class="form-group">
                              <label for="area">Area</label>
                              <input class="form-control form-control-sm" id="area" name = 'area' type="text" value="{{ req.area }}" required>
                            </div>
                            <div class="form-group">
                              <label for="city">City</label>
                              <input class="form-control form-control-sm" id="city" name = 'city' type="text" value="{{ req.city }}" required>
                            </div>
                            <div class="form-group">
                              <label for="state">State</label>
                              <input class="form-control form-control-sm" id="state" name = 'state' type="text" value="{{ req.state }}" required>
                            </div>
                            <div class="form-group">
                              <label for="pincode">Pincode</label>
                              <input class="form-control form-control-sm" id="pincode" name = 'pincode' type="text" value="{{ req.pincode }}" required>
                            </div>
                          </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                          <button id="commaccept" type="submit" class="btn btn-primary">Yes</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>

                  <a href="#modalRejectasExists{{req.pk}}" data-toggle="modal"><i class="fa fa-times fa-border" aria-hidden="true" title="Reject"  style='font-size:14px;color:red; border-color:red;  margin-right: 5px;'></i></a>
                  <div class="modal fade" id="modalRejectasExists{{req.pk}}" tabindex="-1" role="dialog" aria-labelledby="RejectArticleModal" aria-hidden="true">
                    <div class="modal-dialog text-left" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h3 class="modal-title" id="exampleModalLabel">Rejecting the requested Place of Worship</h3>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">
                          <form method = "post" action ="{% url 'handle_community_creation_requests' %}">
                            {% csrf_token %}
                            <input type='hidden' name = 'status' value='rejected'/>
                            <input type='hidden' name = 'pk' value ={{req.requestcommunity.pk}} />
                            <input type='hidden' name = 'community_parent' value ={{req.requestcommunity.parent.pk}} />            
                            <div class="form-group">
                              <label for="reason-text" class="col-form-label">Enter the reason for rejection</label>
                              <textarea class="form-control" id="reason-text" name = 'reason' required></textarea>                                              
                            </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                          <button id="commReject" type="submit" class="btn btn-primary">Yes</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endif %}
                {% endif %}
                  
                {% if req.status == 'Requested' and req.assignedto == request.user %}
                  <a href="#modalRejectmodify{{req.pk}}" data-toggle="modal"><i class="fa fa-scissors fa-border" aria-hidden="true" title="Send for modification" style='font-size:14px;color:red; border-color:red; margin-right: 5px;'></i></a>
                  <div class="modal fade" id="modalRejectmodify{{req.pk}}" tabindex="-1" role="dialog" aria-labelledby="RejectArticleModal" aria-hidden="true">
                    <div class="modal-dialog text-left" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h3 class="modal-title" id="exampleModalLabel">Send back for modification</h3>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">
                          <form method = "post" action ="{% url 'handle_community_creation_requests' %}">
                            {% csrf_token %}
                            <input type='hidden' name = 'status' value='modify'/>
                            <input type='hidden' name = 'pk' value ={{req.requestcommunity.pk}} />
                            <input type='hidden' name = 'community_parent' value ={{req.requestcommunity.parent.pk}} />            
                            <div class="form-group">
                              <label for="reason-text" class="col-form-label">Enter more details about what modification are required</label>
                              <textarea class="form-control" id="reason-text" name='reason'></textarea>                                              
                            </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                          <button id="commReject" type="submit" class="btn btn-primary">Yes</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>
            
          </td>
        </tr>
      {% endfor %}
      {% endautoescape%}
    </tbody>
  </table>

  <div id="view_location_on_map_modal" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-body">
          <div id="map" class="map" style="width:100%; height:500px;"></div>
        </div>
      </div>
    </div>
  </div>

  <br /><br /><br />



{% endblock %}

{% block javascript %}
  <script src="{% static 'js/angular.min.js' %}"></script>

  <script type="text/javascript" src="{% static 'js/ol.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/ol-ext.js' %}"></script>

  <script type="text/javascript">
    var mapview
    var latitude
    var longitude

    function displayLocation(lat, long) {
      latitude = lat;
      longitude = long;
      viewLocationOnMap();
    }

    function viewLocationOnMap() {
      document.getElementById("map").innerHTML = "";
      mapview = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([longitude, latitude]),
          zoom: 16
        })
      });

      var iconStyle = new ol.style.Style({
        image: new ol.style.Icon({
          anchor: [12, 37],
          anchorXUnits: 'pixels', //'fraction'
          anchorYUnits: 'pixels',
          opacity: 0.8,
          src: '../static/assets/pages/img/blue.png'
        })
      });        
      var layer = new ol.layer.Vector({
        source: new ol.source.Vector({
          features: [
            new ol.Feature({
              geometry: new ol.geom.Point(ol.proj.fromLonLat([longitude, latitude]))
            })
          ]
        })
      });
      layer.setStyle(iconStyle)
      mapview.addLayer(layer);
      $("#view_location_on_map_modal").modal('show');
    } 
  </script>

  <script>
    $('#view_location_on_map_modal').on('shown.bs.modal', function () {
      viewLocationOnMap();
    })
  </script>

{% endblock %}